<div class="filter-bar-container" [class.embed-mode]="embedMode">
  <!-- Hierarchy Type Display Section - First position - Hidden in embed mode -->
  <div class="hierarchy-type-section" *ngIf="!embedMode">
    <div class="hierarchy-type-value" 
         *ngIf="currentHierarchyType(); else loadingHierarchyType"
         (click)="openHierarchyConfiguration()"
         tabindex="0"
         role="button"
         aria-label="Click to change hierarchy configuration">
      <span class="hierarchy-type-text">{{ currentHierarchyType()?.groupDescText }}</span>
      <span class="hierarchy-type-code">{{ currentHierarchyType()?.hierarchyTypeCode }}</span>
      <svg class="hierarchy-config-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M12 20h9"></path>
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
      </svg>
    </div>
    <ng-template #loadingHierarchyType>
      <div class="hierarchy-type-loading">Loading...</div>
    </ng-template>
  </div>

  <div class="divider" *ngIf="!embedMode"></div>


  <!-- Hierarchy Configuration Section - Hidden in embed mode -->
  <div class="hierarchy-section" *ngIf="!embedMode">
    <app-hierarchy-selector 
      [config]="hierarchyConfig()"
      [hierarchyTypes]="hierarchyTypes"
      [compactMode]="true"
      (configChange)="onHierarchyConfigChange($event)">
    </app-hierarchy-selector>
  </div>

  <div class="divider" *ngIf="!embedMode"></div>

  <!-- Export Section - Hidden in embed mode -->
  <!-- Child Search Bar -->
  <div *ngIf="childSearchActive()" class="child-search-section">
    <div class="child-search-content">
      <div class="search-input-container">
        <svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="11" cy="11" r="8"/>
          <path d="M21 21l-4.35-4.35"/>
        </svg>
        <input type="text" 
               class="search-input"
               [value]="childSearchTerm()"
               (input)="updateChildSearchTerm($event)"
               (keydown)="onChildSearchKeydown($event)"
               placeholder="Search children..."
               #childSearchInput>
        <button class="clear-search" 
                *ngIf="childSearchTerm()"
                (click)="clearChildSearchTerm()"
                appTooltip="Clear search">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      
      <div class="search-controls">
        <label class="recursive-search-toggle">
          <input type="checkbox" 
                 [checked]="childSearchRecursive()"
                 (change)="toggleRecursiveSearch($event)"
                 appTooltip="When checked, search includes all descendants. When unchecked, search only direct children.">
          <span>Search all levels</span>
        </label>
        
        <span class="search-results-count" *ngIf="searchResults.length > 0">
          {{searchCurrentIndex + 1}} of {{searchResults.length}}
        </span>
        <span class="search-no-results" *ngIf="childSearchTerm() && searchResults.length === 0">
          <ng-container *ngIf="childSearchParent()?.name === 'root' && !childSearchRecursive()">
            No direct children found in root. Try enabling "Search all levels" or select a specific filter/organization to search within.
          </ng-container>
          <ng-container *ngIf="childSearchParent()?.name === 'root' && childSearchRecursive()">
            No results found in entire hierarchy. Try different search terms or check if data is loaded.
          </ng-container>
          <ng-container *ngIf="childSearchParent()?.name !== 'root' && !childSearchRecursive()">
            No direct children found. Try enabling "Search all levels" or select a different parent node.
          </ng-container>
          <ng-container *ngIf="childSearchParent()?.name !== 'root' && childSearchRecursive()">
            No results found in this branch. Try different search terms or select a different parent node.
          </ng-container>
        </span>
        
        <div class="search-navigation">
          <button class="nav-button" 
                  (click)="navigateChildSearchPrevious()"
                  [disabled]="searchResults.length === 0 || searchCurrentIndex <= 0"
                  appTooltip="Previous result">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </button>
          <button class="nav-button" 
                  (click)="navigateChildSearchNext()"
                  [disabled]="searchResults.length === 0 || searchCurrentIndex >= searchResults.length - 1"
                  appTooltip="Next result">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M9 18l6-6-6-6"/>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Hierarchy Path Display - moved after search controls -->
      <div class="search-hierarchy-path" *ngIf="getSearchParentHierarchyPath()" 
           [appTooltip]="getHierarchyTooltipText()">
        <svg class="hierarchy-icon" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M3 3v18h18"/>
          <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
        </svg>
        <span class="hierarchy-text">{{ getSearchParentHierarchyPath() }}</span>
      </div>
    </div>
  </div>

  <div class="divider" *ngIf="childSearchActive()"></div>

  <!-- Export Section - Hidden in embed mode -->
  <div class="export-section" *ngIf="!embedMode">
    <button class="export-button" 
            (click)="exportToExcel()"
            [disabled]="!data || data.length === 0"
            appTooltip="Export data to Excel">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14,2 14,8 20,8"/>
        <line x1="16" y1="13" x2="8" y2="13"/>
        <line x1="16" y1="17" x2="8" y2="17"/>
        <polyline points="10,9 9,9 8,9"/>
      </svg>
      <span>Export</span>
    </button>
  </div>
</div>