<!-- Compact mode for header -->
<div *ngIf="compactMode" class="hierarchy-compact" (click)="onCompactClick()">
  <div class="hierarchy-label">Hierarchy:</div>
  <div class="active-hierarchy" *ngIf="getEnabledLevels().length > 0; else noHierarchy">
    <span *ngFor="let level of getEnabledLevels(); let i = index" 
          class="active-level-compact">
      {{ level.name }}
      <span *ngIf="i < getEnabledLevels().length - 1" class="separator-compact">→</span>
    </span>
    <span class="max-depth-compact">(Max: {{ config.maxDepth }})</span>
  </div>
  <ng-template #noHierarchy>
    <span class="no-hierarchy">Click to configure</span>
  </ng-template>
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="chevron-icon">
    <path d="M6 9l6 6 6-6"/>
  </svg>
</div>

<!-- Full configuration overlay -->
<div *ngIf="compactMode && showFullConfiguration()" class="configuration-overlay" (click)="closeConfiguration()">
  <div class="configuration-panel" (click)="$event.stopPropagation()">
    <div class="panel-header">
      <h3 class="panel-title">Hierarchy Configuration</h3>
      <button class="close-button" (click)="closeConfiguration()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="panel-content">
      <p class="panel-description">Drag to reorder, toggle to enable/disable levels</p>

    <div class="hierarchy-levels" 
         cdkDropList 
         (cdkDropListDropped)="onDrop($event)">
      
      <div *ngFor="let level of pendingConfig.levels; trackBy: trackByLevel"
           class="hierarchy-level"
           [class.enabled]="level.enabled"
           [class.disabled]="!level.enabled"
           cdkDrag>
        
        <div class="level-content">
          <div class="drag-handle" cdkDragHandle>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="9" cy="12" r="1"/>
              <circle cx="9" cy="5" r="1"/>
              <circle cx="9" cy="19" r="1"/>
              <circle cx="15" cy="12" r="1"/>
              <circle cx="15" cy="5" r="1"/>
              <circle cx="15" cy="19" r="1"/>
            </svg>
          </div>

          <div class="level-info">
            <div class="level-name">{{ level.name }}</div>
            <div class="level-description">{{ level.description }}</div>
            <div class="level-id">{{ level.id }}</div>
          </div>

          <div class="level-controls">
            <div class="level-order">{{ level.order + 1 }}</div>
            <label class="toggle-switch">
              <input type="checkbox" 
                     [checked]="level.enabled"
                     (change)="toggleLevel(level.id)">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <div *cdkDragPreview class="drag-preview">
          {{ level.name }}
        </div>
      </div>
    </div>

    <div class="hierarchy-summary" *ngIf="getPendingEnabledLevels().length > 0">
      <h4>Preview Hierarchy:</h4>
      <div class="active-levels">
        <span *ngFor="let level of getPendingEnabledLevels(); let i = index" 
              class="active-level">
          {{ level.name }}
          <span *ngIf="i < getPendingEnabledLevels().length - 1" class="separator">→</span>
        </span>
      </div>
    </div>

    <!-- Max Depth Selector for compact mode -->
    <div class="max-depth-container">
      <label>Max Depth:</label>
      <select [(ngModel)]="pendingConfig.maxDepth" class="max-depth-select">
        <option *ngFor="let depth of [1,2,3,4,5]" [value]="depth">{{ depth }}</option>
      </select>
    </div>

    <div class="panel-actions">
      <button class="action-button cancel-button" (click)="cancelConfiguration()">
        Cancel
      </button>
      <button class="action-button apply-button" (click)="applyConfiguration()">
        Apply Changes
      </button>
    </div>
    </div>
  </div>
</div>

<!-- Full mode (original) -->
<div *ngIf="!compactMode" class="hierarchy-selector" [class.modal-content]="modalMode">
  <div class="hierarchy-header">
    <h3 class="hierarchy-title">Hierarchy Configuration</h3>
    <p class="hierarchy-description">Drag to reorder, toggle to enable/disable levels</p>
  </div>

  <div class="hierarchy-levels" 
       cdkDropList 
       (cdkDropListDropped)="onDrop($event)">
    
    <div *ngFor="let level of (modalMode ? pendingConfig.levels : config.levels); trackBy: trackByLevel"
         class="hierarchy-level"
         [class.enabled]="level.enabled"
         [class.disabled]="!level.enabled"
         cdkDrag>
      
      <div class="level-content">
        <div class="drag-handle" cdkDragHandle>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="9" cy="12" r="1"/>
            <circle cx="9" cy="5" r="1"/>
            <circle cx="9" cy="19" r="1"/>
            <circle cx="15" cy="12" r="1"/>
            <circle cx="15" cy="5" r="1"/>
            <circle cx="15" cy="19" r="1"/>
          </svg>
        </div>

        <div class="level-info">
          <div class="level-name">{{ level.name }}</div>
          <div class="level-description">{{ level.description }}</div>
          <div class="level-id">{{ level.id }}</div>
        </div>

        <div class="level-controls">
          <div class="level-order">{{ level.order + 1 }}</div>
          <label class="toggle-switch">
            <input type="checkbox" 
                   [checked]="level.enabled"
                   (change)="toggleLevel(level.id)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <div *cdkDragPreview class="drag-preview">
        {{ level.name }}
      </div>
    </div>
  </div>

  <div class="hierarchy-summary" *ngIf="(modalMode ? getPendingEnabledLevels() : getEnabledLevels()).length > 0">
    <h4>{{ modalMode ? 'Preview Hierarchy:' : 'Active Hierarchy:' }}</h4>
    <div class="active-levels">
      <span *ngFor="let level of (modalMode ? getPendingEnabledLevels() : getEnabledLevels()); let i = index" 
            class="active-level">
        {{ level.name }}
        <span *ngIf="i < (modalMode ? getPendingEnabledLevels() : getEnabledLevels()).length - 1" class="separator">→</span>
      </span>
    </div>
  </div>

  <!-- Max Depth Selector -->
  <div class="max-depth-container">
    <label>Max Depth:</label>
    <select [value]="getCurrentMaxDepth()" 
            (change)="onMaxDepthChange($event)"
            class="max-depth-select">
      <option *ngFor="let depth of [1,2,3,4,5]" [value]="depth">{{ depth }}</option>
    </select>
  </div>

  <!-- Apply/Cancel buttons for modal mode -->
  <div class="panel-actions" *ngIf="modalMode">
    <button class="action-button cancel-button" (click)="cancelConfiguration()">
      Cancel
    </button>
    <button class="action-button apply-button" (click)="applyConfiguration()">
      Apply Changes
    </button>
  </div>
</div>