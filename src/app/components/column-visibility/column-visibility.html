<div class="column-visibility-container">
  <ng-container *ngIf="showAsDropdown; else inlineControls">
    <!-- Dropdown button -->
    <button 
      class="column-visibility-button"
      [class.vertical-layout]="verticalLayout"
      (click)="toggleDropdown()"
      [class.active]="dropdownOpen"
      appTooltip="Show/hide columns"
      type="button">
      <svg *ngIf="!verticalLayout" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="6" x2="21" y2="6"/>
        <line x1="3" y1="12" x2="21" y2="12"/>
        <line x1="3" y1="18" x2="21" y2="18"/>
      </svg>
      <!-- Vertical layout icon (rotated lines) -->
      <svg *ngIf="verticalLayout" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="6" y1="3" x2="6" y2="21"/>
        <line x1="12" y1="3" x2="12" y2="21"/>
        <line x1="18" y1="3" x2="18" y2="21"/>
      </svg>
    </button>
    
    <!-- Dropdown menu -->
    <div class="column-visibility-dropdown" *ngIf="dropdownOpen">
      <div class="dropdown-header">
        <h4>Column Visibility</h4>
        <div class="quick-actions">
          <button class="quick-action-btn" (click)="onShowAll()" appTooltip="Show all columns">
            Show All
          </button>
          <button class="quick-action-btn" (click)="onHideNonEssential()" appTooltip="Hide all except essential">
            Hide All
          </button>
          <button class="quick-action-btn" (click)="onResetDefaults()" appTooltip="Reset to defaults">
            Reset
          </button>
        </div>
      </div>
      
      <div class="column-list">
        <div 
          *ngFor="let column of columns; trackBy: trackByColumn" 
          class="column-item"
          [class.essential]="isEssentialColumn(column)"
          [class.disabled]="isEssentialColumn(column)">
          
          <label class="column-checkbox">
            <input 
              type="checkbox" 
              [checked]="visibilityService.isColumnVisible(column.key)"
              [disabled]="isEssentialColumn(column)"
              (change)="onToggleColumn(column, $event)"
            />
            <span class="checkmark"></span>
            <span class="column-name">{{ getColumnLabel(column) }}</span>
            <span class="essential-badge" *ngIf="isEssentialColumn(column)">Required</span>
          </label>
        </div>
      </div>
      
      <div class="dropdown-footer">
        <span class="visible-count">
          {{ getVisibleColumnCount() }} of {{ columns.length }} columns visible
        </span>
      </div>
    </div>
    
    <!-- Backdrop to close dropdown -->
    <div class="column-visibility-backdrop" *ngIf="dropdownOpen" (click)="toggleDropdown()"></div>
  </ng-container>
  
  <!-- Inline controls template -->
  <ng-template #inlineControls>
    <div class="inline-column-controls">
      <h4>Column Visibility</h4>
      <div class="quick-actions">
        <button class="quick-action-btn" (click)="onShowAll()">Show All</button>
        <button class="quick-action-btn" (click)="onHideNonEssential()">Hide All</button>
        <button class="quick-action-btn" (click)="onResetDefaults()">Reset</button>
      </div>
      
      <div class="column-grid">
        <div 
          *ngFor="let column of columns; trackBy: trackByColumn" 
          class="column-item"
          [class.essential]="isEssentialColumn(column)"
          [class.disabled]="isEssentialColumn(column)">
          
          <label class="column-checkbox">
            <input 
              type="checkbox" 
              [checked]="visibilityService.isColumnVisible(column.key)"
              [disabled]="isEssentialColumn(column)"
              (change)="onToggleColumn(column, $event)"
            />
            <span class="checkmark"></span>
            <span class="column-name">{{ getColumnLabel(column) }}</span>
            <span class="essential-badge" *ngIf="isEssentialColumn(column)">Required</span>
          </label>
        </div>
      </div>
      
      <div class="visible-count">
        {{ getVisibleColumnCount() }} of {{ columns.length }} columns visible
      </div>
    </div>
  </ng-template>
</div>